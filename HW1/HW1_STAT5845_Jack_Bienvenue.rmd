---
title: "Homework 1 - Replicating Covid Charts"
author: Jack Bienvenue
date: 25 August 2025
format: pdf
header-includes:
  - \usepackage{tcolorbox}
  - \tcbset{colback=red!10!white, colframe=red!80!black, boxrule=0.5pt, arc=3pt, left=6pt, right=6pt, top=6pt, bottom=6pt}
  - \usepackage{xcolor}
  - \newcommand{\red}[1]{\textcolor{red}{#1}}
---

``` {r, echo=FALSE}
# Preliminaries --> Package and Data Import, Data Cleaning

# Package Import
invisible(lapply(c("ggplot2", "dplyr", "tidyr", "sf", "stringr", "tigris", 
                   "RColorBrewer", "scales", "patchwork", "ggtext"),
  function(pkg) {
    suppressWarnings(suppressMessages(
      library(pkg, character.only = TRUE)))}))

# Data Import

## NYT COVID data
pre_us_counties_2020_df <- read.csv("./data/us-counties-2020.csv")

us_df <- read.csv("./data/us.csv") %>%
  mutate(
    date = as.Date(date)
  ) %>%
  filter(date <= as.Date("2020-09-30") & date >= as.Date("2020-03-01"))

us_states_df <- read.csv("./data/us-states.csv") %>%
  mutate(
    date = as.Date(date)
  ) %>%
  filter(date <= as.Date("2020-09-30") & date >= as.Date("2020-03-01"))

## County Shapefiles

options(tigris_use_cache = TRUE)  # for quickness
counties_sf <- counties(cb = TRUE, year = 2020, class = "sf")

# Data Cleaning

## Making County, State names compatible:

### US County Covid Cases
us_counties_2020_df <- pre_us_counties_2020_df %>%
  mutate(
    fips = sprintf("%05s", fips),
    fips = as.character(fips),
    county = str_to_lower(county),
    state = str_to_lower(state),
    date = as.Date(date)
  ) %>%
  filter(date ==as.Date("2020-08-31")) # Pick out 8/31/20

### US County shapefiles (Contig. 48 only!)

us_counties_shp <- counties_sf %>%
  mutate(fips = as.character(GEOID)) %>%
  filter( !STATE_NAME %in% c(
      "Alaska", "Hawaii", 
      "Puerto Rico", 
      "American Samoa", 
      "Guam", 
      "Commonwealth of the Northern Mariana Islands", 
      "United States Virgin Islands"))

## Spatially joining data to make map:
joined_map <- left_join(us_counties_shp, us_counties_2020_df, by = "fips")
```

---

## Figure 1: Data over Space---County-wise COVID Cases

```{=tex}
\raggedright
```

*Data used: us-counties-2020.csv, 2020 TIGER County Shapefiles*

```{r, echo=FALSE}
ggplot(joined_map) +
  geom_sf(aes(fill = cases), color = "white", size = 0.1) +
  coord_sf(crs = 3083) +  # Lambert projection
  theme_minimal() +
  scale_fill_gradientn(
  colors = c("#fff3c4", 
             "#FF6500",  
             "#8B0000"), 
  na.value = "gray90"
) +
  labs(
    title = "COVID-19 Cases by County on 2020-08-31",
    fill = "COVID-19 Cases",
    caption="Source:https://www.nytimes.com/interactive/2021/us/covid-cases.html"
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", size=9),
    plot.caption = element_text(hjust = 0, face = "bold", size = 7, 
                                family = "mono"),  
    legend.title = element_text(size = 7, face = "bold"),
    legend.text = element_text(size = 6),       
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.ticks = element_blank(),
    axis.text = element_blank()
  )
```

```{=tex}
\centering{\red{Question: What patterns do you notice in this map?}}

\begin{tcolorbox}
It appears that urban areas have far greater case counts than rural counterparts, particularly in the American South. For instance, LA County,  Miami-Dade county, Maricopa (Phoeniz, AZ) County, Clark (Las Vegas, NV) County, and Harris (Houston, TX) County, appear to be hotspots.

I also notice the presence of spatial clustering of both high-- and low-count counties. Often, suburbs form gradients from low to high case count areas between high-- and low-clusters.
\end{tcolorbox}
```

---

## Figure 2: Data over Time---US COVID Case Time Series

```{=tex}
\raggedright
```

*Data used: us.csv*

```{r, echo=FALSE}

# Record 7-day avg., total cases, total deaths
avg_7_day <- tail(us_df$cases_avg, 1)
total_cases <- sum(us_df$cases, na.rm=TRUE)
total_deaths <- sum(us_df$deaths, na.rm=TRUE)

ggplot(data = us_df, aes(x = date)) +
  # Area and line (with legend entries)
  geom_area(aes(y = cases), fill = "pink", alpha = 0.6) +
  geom_line(aes(y = cases_avg, color = "7-day average"), linewidth = 1) +
  
  scale_x_date(
    date_breaks = "1 month", 
    date_labels = "%b" 
  ) +
  
  scale_y_continuous(labels = comma) +
  
  labs(
    title = "COVID-19 Cases in the United States",
    subtitle = "Daily New Cases and 7-Day Average",
    y = "New Cases",
    x = NULL,
    fill = "",  
    color = "", 
    caption = paste0("Data through September 30, 2020\n", 
          "Source:https://www.nytimes.com/interactive/2021/us/covid-cases.html")
  ) +
  
  # Manual legend colors
  scale_color_manual(
    values = c("7-day average" = "red"),
    labels = c(paste0("7-day average\n", format(round(avg_7_day, 0), 
                                                big.mark=",")))
  ) +
  
  theme_minimal() +
  theme(
    plot.title = element_text(size = 15, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 9, color = 'gray50', hjust = 0.5),
    axis.title.y = element_text(size = 10, face = "bold"),
    axis.text = element_text(size = 7),
    legend.position = c(0.05, 0.95),
    legend.justification = c("left", "top"),
    legend.background = element_blank(),
    legend.text = element_text(color = "red"),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(color = "gray90"),
    panel.grid.minor.y = element_blank(),
    axis.line = element_blank(),
    plot.caption = element_text(size = 7, color = "gray50", hjust = 1)
  ) +
  
  # Annotations (rich text so <br> works)
  annotate("text",
         x = max(us_df$date),
         y = max(us_df$cases, na.rm = TRUE) * 0.95,
         label = paste0("TOTAL CASES: ", "\n", format(total_cases, 
                        big.mark=",")),
         hjust = 1, size = 3.5, color = "gray10", fontface = "bold") +
  annotate("text",
         x = max(us_df$date),
         y = max(us_df$cases, na.rm = TRUE) * 0.95,
         label = paste0("\n\n\n\n\n", "DEATHS: ", "\n", format(total_deaths, 
                        big.mark=",")),
         hjust = 1, size = 3.5, color = "gray10", fontface = "bold") 

```

```{=tex}
\centering{\red{Question: Looking at this time series, what future behavior would you expect?}}

\begin{tcolorbox}
Extrapolating qualitatively, it is difficult to say. One hypothesis is that a third, higher peak will emerge before leveling off like the two previous peak-decline cycles. We may expect this to happen with the onset winter. Alternatively, it is possible in the near future that the leveling off will continue, or that only modest increases in cases occur. Because of the nature of disease, we should expect smooth changes in case counts, no matter which direction the case counts move. 
\end{tcolorbox}
```

---

## Figure 3: Data over Space & Time---State-partitioned COVID Case Time Series

```{=tex}
\raggedright
```

*Data used: us-states.csv*

```{r, echo=FALSE, warning=FALSE}
states_to_plot <- c(
  "California","Texas","Florida","New York","Georgia",
  "Illinois","Arizona","North Carolina","New Jersey",
  "Tennessee","Louisiana","Pennsylvania"
)

us_states_df$date <- as.Date(us_states_df$date)

# Filter for selected states
plot_df <- us_states_df %>% filter(state %in% states_to_plot)

# Create a list to store individual state plots
plots_list <- list()

ncol_grid <- 4
nrow_grid <- 3

for (i in seq_along(states_to_plot)) {
  
  st <- states_to_plot[i]
  state_df <- plot_df %>% filter(state == st)
  avg_7_day <- round(tail(state_df$cases_avg, 1), 0)
  
  y_max <- max(max(state_df$cases, na.rm = TRUE), 
               max(state_df$cases_avg, na.rm = TRUE), 10000)
  
  p <- ggplot(state_df, aes(x = date)) +
    geom_area(aes(y = cases), fill = "pink", alpha = 0.75) +
    geom_line(aes(y = cases_avg), color = "red", linewidth = 0.3) +
    annotate("text", x = min(state_df$date), y = y_max, 
             label = paste0("7-day\n","average"), color = "red", hjust = 0, 
             vjust = 1, size = 1.5) +
    annotate("text", x = max(state_df$date), y = y_max,
    label = "Last 14 \n days", color = "gray50", hjust = 1, vjust =1, size =1.5
    ) +
    scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    scale_y_continuous(
      limits = c(0, y_max),                       
      labels = scales::label_number(scale = 1/1000, suffix = "k") 
    ) +
    labs(title = st) +
    theme_minimal() +
    theme(
      plot.title = ggtext::element_textbox_simple(
        size = 5, face = "bold", hjust = 0.5, halign = 0.5,
        margin = margin(b = 2), fill = "gray90", box.color = NA         
      ),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.x = element_text(size = 3.5, color="gray50"),
      axis.text.y = element_text(size=3.5, color="gray50"),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.major.y = element_line(color = "gray90"),
      panel.grid.minor.y = element_blank(),
      axis.line = element_blank()
    )
  
  # Remove x-axis text if NOT on bottom row
  if (i <= (nrow_grid - 1) * ncol_grid) {
    p <- p + theme(axis.text.x = element_blank())
  } else {
    p <- p + theme(axis.text.x = element_text(size = 4, color="gray50"))
  }
  
  plots_list[[st]] <- p
}

# Combine into a 3x4 grid with overarching title and subtitle
final_plot <- wrap_plots(plots_list, ncol = ncol_grid) +
  plot_annotation(
  title = "COVID-19 Cases by State",
  subtitle = "Daily New Cases and 7-Day Average, March 01--September 30, 2020",
  caption = paste0("7-day average shown in red line\n", "Source:https://www.nytimes.com/interactive/2021/us/covid-cases.html"),
  theme = theme(
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 8, hjust = 0.5, color="gray40"),
    plot.caption = element_text(size = 6, color="gray50", hjust = 1)
  )
)

final_plot
```

```{=tex}
\centering{\red{Question: Do all states follow the same pattern, or do some rise and fall earlier than others?}}

\begin{tcolorbox}
It does not appear that all states follow the same pattern. However, neighboring states appear to have more similarity in their patterns. This homogeneity could have a number of causes; regardless of cause, it is important that states observe their own data, as well as their neighbors' data in order to construct policy effectively for mitigating the spread of disease.
\end{tcolorbox}
```
