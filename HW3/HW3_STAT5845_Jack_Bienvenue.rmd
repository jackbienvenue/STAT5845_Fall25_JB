---
title: "Homework 3 - 2018 Housing Prices in CT"
author: Jack Bienvenue
date: 12 September 2025
format: pdf
header-includes:
  - \usepackage{tcolorbox}
  - \tcbset{colback=red!10!white, colframe=red!80!black, boxrule=0.5pt, arc=3pt, left=6pt, right=6pt, top=6pt, bottom=6pt}
  - \usepackage{xcolor}
  - \newcommand{\red}[1]{\textcolor{red}{#1}}
---

# Task 1: Replicating CT Home Value Map

```{r}
# Package import
invisible(suppressWarnings(suppressMessages(lapply(c("sp", "spdep", "ggplot2",
                                                     "gstat", "sf", 
                                                     "RColorBrewer"), 
                                            require, character.only = TRUE))))
# Data import
## Median home values for CT towns
med_home_ct18_df <- read.csv("./data/median-home-value-town-2018.csv")
## CT towns (I am importing from my own shapefile I produced in the past)
ct_shp<- st_read("./data/ct_towns/ct_towns.shp")

# Inspect shapefile

```
Let's start preparing for our analysis by cleaning our data.

```{r}
# Ensure only Connecticut's towns are included for the shapefile
ct_shp = ct_shp[ct_shp$CT_LEGEND == "Connecticut", ]

# Ensure only relevant data is present in our home value dataframe:
med_home_ct18_df = (
  med_home_ct18_df[med_home_ct18_df$Variable == "Median Home Value" &
                     med_home_ct18_df$Year == "2014-2018" &
                     med_home_ct18_df$Measure.Type == "Number",]
)
```

To replicate the plot for Task 1, we will have to start by obtaining Z-scores for the median home value of each town. After that, we will merge the data sets. At last we will reproduce the map.

```{r}
# Create Z-score column
med_home_ct18_df$med_home_val_z_score <- scale(med_home_ct18_df$Value)

# Merge data
ct_med_home_18_geom <- merge(ct_shp, med_home_ct18_df, 
                   by.x = "TOWN_NAME", 
                   by.y = "Town", 
                   all.x = TRUE)
# Build map 
ggplot(data = ct_med_home_18_geom) +
  # Fill each tract polygon by its standardized incidence
  geom_sf(aes(fill = med_home_val_z_score)) +
  # Diverging color scale: red = above average, blue = below average
  scale_fill_gradient2(low = "blue", mid = "white", high = "red",
                       midpoint = 0,
                       name = "Standardized Z") +
  # Add labels
  labs(title = "Standardized Median Home Value (Z-scores)",
       subtitle = "Z = 0 is the statewide average; red = above, blue = below") +
  theme_minimal()
```


```{=tex}
\centering{\red{Question: What can you say about the home values in CT?}}

\begin{tcolorbox}
We can see easily in our map that there is a concentration of high median home values for towns in Southwestern Connecticut---the corner of the state closest to New York City. We see high home values in a few other enclaves, including around Lyme, Connecticut (which is near major, lucrative employers Pfizer, Electric Boat, US Coast Guard Academy, and Dominion Energy) and along the western border of the state, where country homes for wealthy vacation home owners are located. We see that the inland, eastern portion of the state generally possesses lower-than-median home values. We also see bands of lower-than-median home value towns in the central-western portion of the state. This plot does not provide information about absolute-scale median home prices. 
\end{tcolorbox}
```

# Task 2: Replicating Moran's I Scatterplot

```{r}
# Shared boundary condition for neighbors definition
## To let poly2nb work, we have to convert our sf object to a sp object:
ct_med_home_18_geom <- as(ct_med_home_18_geom, "Spatial")
ct_towns_nb <- poly2nb(ct_med_home_18_geom)

# 1) Row-standardized neighbor weights (neighbors sum to 1 for each tract)
W_ct_towns <- nb2listw(ct_towns_nb, style = "W", zero.policy = TRUE)

# 2) Spatial lag = neighbor average of Z (using the standardized values)
z      <- ct_med_home_18_geom$med_home_val_z_score
lag_z  <- lag.listw(W_ct_towns, z, zero.policy = TRUE)

# 3) Global index (slope) for reference
mt <- moran.test(z, W_ct_towns, zero.policy = TRUE)
I_hat <- as.numeric(mt$estimate[["Moran I statistic"]])

# 4) Scatterplot: each point = one tract
plot(z, lag_z,
     xlab = "Standardized median home value (Z)",
     ylab = "Spatial lag of Z (average of neighbors)",
     main = "Moran Scatterplot -- CT Median Home Values",
     pch  = 19, col = "grey35")
abline(h = 0, v = 0, col = "grey75", lty = 2)

# 5) Fitted line with slope equal to Moran’s I (intercept fixed at 0)
abline(a = 0, b = I_hat, col = "red", lwd = 2)

# 6) Annotate slope
legend("topleft",
       legend = paste0("Slope (Moran's I) = ", round(I_hat, 3)),
       bty = "n", text.col = "red")

# How to read this:
# - Each dot compares a tract’s standardized Z to the average Z of its neighbors.
# - An upward cloud and a positive red slope mean nearby tracts tend to be alike
#   (high-with-high, low-with-low). A flat or downward pattern would mean weak
#   or negative spatial dependence.
```

```{=tex}
\centering{\red{Question: What can you say about the spatial autocorrelation of home values in CT?}}

\begin{tcolorbox}
I
\end{tcolorbox}
```

# Task 3: Replacing Spatial Clustering Map

```{r}
## --- Local clusters: Where are the highs and lows? (LISA) -------------------

# 1) Standardize the variable and compute its spatial lag (neighbor average)
lag_z <- lag.listw(W_ct_towns, med_home_val_z_score, zero.policy = TRUE)

# 2) Local Moran’s I for each tract (tests local clustering/outliers)
lisa <- localmoran(med_home_val_z_score, W_ct_towns, zero.policy = TRUE)

# 3) Attach key outputs back to the map for plotting
med_home_ct18_df$Ii      <- lisa[, "Ii"]                                 # local I statistic
p_col        <- grep("^Pr\\(", colnames(lisa), value = TRUE)        # robust p-value column
med_home_ct18_df$Ii_p    <- lisa[, p_col]                                        # pseudo p-value
med_home_ct18_df$Z_std   <- z_std
med_home_ct18_df$lag_std <- lag_z

# 4) Classify each tract into LISA quadrants (α = 0.05)
alpha <- 0.05
med_home_ct18_df$quad <- "Not sig."
med_home_ct18_df$quad[med_home_ct18_df$Ii_p <= alpha &  med_home_ct18_df$Z_std >= 0 &  med_home_ct18_df$lag_std >= 0] <- "High-High"
med_home_ct18_df$quad[med_home_ct18_df$Ii_p <= alpha &  med_home_ct18_df$Z_std <= 0 &  med_home_ct18_df$lag_std <= 0] <- "Low-Low"
med_home_ct18_df$quad[med_home_ct18_df$Ii_p <= alpha &  med_home_ct18_df$Z_std >= 0 &  med_home_ct18_df$lag_std <= 0] <- "High-Low"
med_home_ct18_df$quad[med_home_ct18_df$Ii_p <= alpha &  med_home_ct18_df$Z_std <= 0 &  med_home_ct18_df$lag_std >= 0] <- "Low-High"

# 5) Plot: LISA cluster map (hot/cold clusters and spatial outliers)
p_lisa <- ggplot(med_home_ct18_df) +
  geom_sf(aes(fill = factor(quad)), color = "grey70", size = 0.2) +
  scale_fill_manual(
    name   = "LISA quadrant (α = 0.05)",
    values = c("High-High" = "#d73027",  # hotspot cluster
               "Low-Low"  = "#4575b4",   # coldspot cluster
               "High-Low" = "#fdae61",   # high surrounded by low (outlier)
               "Low-High" = "#74add1",   # low surrounded by high (outlier)
               "Not sig." = "grey85")
  ) +
  labs(
    title = "Local Moran’s I — CT Median Home Values",
    subtitle = "Standardized values (Z-scores); queen contiguity, row-standardized weights"
  ) +
  theme_minimal() +
  theme(legend.position = "right")

print(p_lisa)

# What we see:
# - Each tract is labeled by how it relates to its neighbors:
#   • High–High: high Z with high neighbors → hotspot clusters.
#   • Low–Low:   low Z with low neighbors → coldspot clusters.
#   • High–Low / Low–High: spatial outliers (a tract unlike its neighborhood).
#   • Not sig.: no clear local pattern at α = 0.05.
# - This local view reveals *where* the global spatial dependence is strongest,
#   highlighting pockets of elevated or depressed incidence and pinpointing
#   tracts that buck their surroundings.
```

```{=tex}
\centering{\red{Question: What can you say about the spatial clustering of housing prices in CT? Why do
High–High clusters appear in the southwest part of the state?}}

\begin{tcolorbox}
The clustering as shown illuminates the fact that some towns of Southwestern Connecticut---in particular, a subset of Fairfield County's towns---have high average home values, and their neighboring towns do as well.

We notice an absence of the other cluster types.

ISSUE TO RESOLVE: ENSURE THAT THE QUEEN CONTIGUITY IS ACTUALLY BEING APPLIED HERE!!!!!!!!!!!!

\end{tcolorbox}
```